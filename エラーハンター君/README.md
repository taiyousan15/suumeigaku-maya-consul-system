# エラーハンター君 - 世界最高のエラー解析・修正エージェント軍団

## 🎯 概要

エラーハンター君は、世界中の一流企業で成功を収めてきたエンジニア集団の知見を結集した、最速・最高精度のエラー解析・修正・再発防止を実現するエージェント軍団です。

### 絶対原則

1. **結論先出し** - 常に結論を最初に提示
2. **最小差分** - 必要最小限の変更のみ実施
3. **テスト同時追加** - 修正と同時にテストを作成
4. **ロールバック容易** - いつでも元に戻せる設計
5. **再発防止完結** - 監視・ガード・ドキュメントまで完遂

### 禁止事項

- 大規模リファクタリング
- 推測だけの修正
- 思考過程の垂れ流し
- 設定や鍵の露出
- 依存のメジャー更新（必要時は影響調査とピン留め）

## 🏗️ エージェント軍団の構成

### 1. 統括エージェント（指揮官）
- **役割**: エラー情報の受付、エージェント軍団の指揮、最終報告の統合
- **責任**: プロジェクト全体の把握、優先度判断、リスク評価

### 2. 症状分析エージェント
- **役割**: エラーの症状を詳細に分析
- **出力**: 症状整理、再現手順、期待値vs実際の挙動、発生頻度、影響範囲

### 3. 根本原因特定エージェント
- **役割**: 複数の仮説を立て、優先度順に検証して真因を特定
- **手法**: ログ解析、コード静的解析、差分解析、依存関係分析
- **出力**: 根拠付きの原因確定、再現実験結果

### 4. 修正パッチ作成エージェント
- **役割**: 最小差分で安全な修正パッチを作成
- **原則**: 1つの原因に対して1つの修正、周辺への影響最小化
- **出力**: diff形式の修正パッチ、変更理由の明記

### 5. テスト作成エージェント
- **役割**: 修正に対する自動テストを作成
- **種類**: Unit Test, Integration Test, E2E Test
- **出力**: 実行可能なテストコード、検証コマンド

### 6. 再発防止エージェント
- **役割**: 同じエラーが二度と起きないようにシステムを強化
- **施策**: 監視項目追加、静的解析ルール追加、型強化、ガード追加
- **出力**: 監視設定、CI/CDパイプライン改善案、ドキュメント更新

## 📋 実行フロー

```
[ユーザー] エラー報告
    ↓
[統括エージェント] 受付・トリアージ
    ↓
[症状分析エージェント] 詳細分析 → 症状レポート
    ↓
[根本原因特定エージェント] 真因特定 → 原因レポート
    ↓
[修正パッチ作成エージェント] 修正実装 → パッチ
    ↓
[テスト作成エージェント] テスト作成 → テストコード
    ↓
[再発防止エージェント] 恒久対策 → 防止策
    ↓
[統括エージェント] 最終報告統合 → ユーザーへ報告
```

## 📊 出力フォーマット（厳守）

### 要約
- **原因**: [1行で根本原因]
- **対応**: [1行で実施した修正]
- **影響**: [影響範囲と優先度]

### 根拠
- **ログ引用**: [該当ログの抜粋]
- **関連コード**: `path/to/file.ts:123`
- **決定打**: [なぜそれが原因と断定できるか]

### 修正パッチ
```diff
# file: path/to/file.ts
- 旧コード
+ 新コード
```

### テスト
- **追加テストの目的**: [何を保証するか]
- **実行**: `npm run test:unit`

### 検証コマンド
```bash
# 再現
[エラーを再現するコマンド]

# 修正後検証
[修正が効いていることを確認するコマンド]
```

### リスクとロールバック
- **リスク**: [潜在的なリスク]
- **ロールバック手順**: [元に戻す方法]

### 再発防止
- **監視**: [追加する監視項目]
- **静的解析/型/ガード**: [追加する保護機構]
- **手順書更新**: [更新するドキュメント]

## 🔍 よくあるエラーの即時対応表（Playbook）

### 依存解決（Node/Java/Python）
1. ロック再生成
2. 重複/メジャー衝突の列挙
3. 最小ピン/範囲縮小
4. 再ビルド

### 環境差異（dev/prod）
1. ENV diff出力
2. 機密はマスク
3. 必須ENVのスキーマ化（zod/pydantic等）

### NPE/属性エラー
1. 入力境界でのガード
2. 型補強
3. フェイルファスト
4. 回帰テスト

### 時相/レース/非同期
1. 逐次化
2. リトライ with backoff
3. タイムアウト
4. サーキットブレーカ

### I/O/ネットワーク
1. 接続先健全性
2. 権限確認
3. スロットリング
4. エラーカテゴリ毎の扱い分離

### SQL/ORマッパ
1. 破壊的マイグレーション検出
2. トランザクション境界
3. インデックス/ロック検証

### フロント（型・状態・API境界）
1. APIスキーマ固定
2. 境界のzod/TypeScript型
3. Suspense/エラーバウンダリ

## 🛡️ Quality Gates（自動チェック）

すべての修正は以下をパスする必要があります：

1. **Lint/Format** - コードスタイル統一
2. **Type check** - 型安全性
3. **Unit Test** - 単体テスト
4. **E2E Test** - 統合テスト
5. **Coverage > 80%** - カバレッジ基準
6. **観測点追加** - ログ/メトリクス/トレース

失敗時は修正差分の縮小 → 原因を一点突破 → 再実行

## 📝 使用方法

### 1. エラー報告テンプレート

```
[症状]:
[期待値]:
[実際]:
[再現手順]: （CLIで再生できる形／最小）
[発生頻度]:
[影響範囲]:
[直近の変更]: （コミットID/PR）
[代表ログ]: （先頭〜"caused by"付近まで）
[環境]: （OS/ランタイム/依存バージョン/FeatureFlag）
[優先度の事情]: （期限/影響/回避策の有無）
```

### 2. エージェント起動

```bash
# 統括エージェントにエラー報告を投げる
claude --agent 統括エージェント "エラー報告内容"
```

### 3. 各エージェントの詳細

- [01_統括エージェント.md](./01_統括エージェント.md) - 指揮官
- [02_症状分析エージェント.md](./02_症状分析エージェント.md) - 症状整理
- [03_根本原因特定エージェント.md](./03_根本原因特定エージェント.md) - 真因特定
- [04_修正パッチ作成エージェント.md](./04_修正パッチ作成エージェント.md) - 修正実装
- [05_テスト作成エージェント.md](./05_テスト作成エージェント.md) - テスト作成
- [06_再発防止エージェント.md](./06_再発防止エージェント.md) - 恒久対策

## 🎓 運用ガイドライン

### 優先度判定基準

**MVP順**: 再現性 × 影響 × 修正コスト

| 再現性 | 影響 | 修正コスト | 優先度 |
|--------|------|-----------|--------|
| 100%   | Critical | 低 | P0 (即対応) |
| 100%   | High | 低 | P1 (当日中) |
| 50%    | High | 低 | P2 (週内) |
| 低     | Low  | 高 | P3 (バックログ) |

### 修正の3原則

1. **最小差分** - 変更は必要最小限
2. **ロールバック容易** - git revert一発で戻せる
3. **テスト同時追加** - 修正とテストは必ずセット

### CI提案（任意）

- PRに必須ラベル: `bugfix` / `patch-only`
- 変更行直下に観測ログを暫定導入 → 安定後に冗長度調整
- 依存は範囲固定（`^`を外す / renovateで週次バッチ）

## 🔒 セキュリティ・機密情報の扱い

- ENV変数は必ずマスク
- 鍵・トークンは絶対に露出させない
- ログ出力時は機密情報をサニタイズ
- パッチにはダミー値を使用

## 📈 成功指標（KPI）

- **MTTR（Mean Time To Repair）**: エラー報告から修正完了まで < 2時間
- **再発率**: 同一エラーの再発 < 5%
- **テストカバレッジ**: 新規追加コード > 80%
- **ロールバック率**: 緊急ロールバック < 1%

## 🤝 貢献

エラーハンター君への改善提案は大歓迎です。Playbookの追加、エージェントの機能拡張など、ぜひご提案ください。

---

**エラーハンター君 v1.0.0**

世界最高のエラー解析・修正を、あなたのプロジェクトに。
