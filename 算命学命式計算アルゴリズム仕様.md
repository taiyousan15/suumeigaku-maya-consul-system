# **算命学命式計算アルゴリズム仕様**

## **1\. 干支算出ロジック**

### **年柱（年干・年支）**

* 年柱は **西暦年** を基に干支を決定。算命学では「立春（節分前後）」を年替わりとするため、入力生年月日が立春以前の場合は前年を採用。

* 干支は60年周期で、次の配列を利用：

`TENKAN = ["庚", "辛", "壬", "癸", "甲", "乙", "丙", "丁", "戊", "己"]`  
`CHISHI = ["申", "酉", "戌", "亥", "子", "丑", "寅", "卯", "辰", "巳", "午", "未"]`

* 算出式：

`year_mod10 = year % 10`  
`year_mod12 = year % 12`  
`year_gan = TENKAN[year_mod10]`  
`year_shi = CHISHI[year_mod12]`

* 例：2020年 → 2020%10=0（庚）、2020%12=4（子）→「庚子年」。

---

### **月柱（月干・月支）**

* 月支：立春を第1月（寅月）とし、以降12節気ごとに1支進む。

`節気と月支：`  
`立春→寅、啓蟄→卯、清明→辰、立夏→巳、芒種→午、`  
`小暑→未、立秋→申、白露→酉、寒露→戌、立冬→亥、大雪→子、小寒→丑`

* 月干：五虎遁（ごことん）の法則を使用。

| 年干 | 寅月の干（起点） |
| ----- | ----- |
| 甲・己 | 丙 |
| 乙・庚 | 戊 |
| 丙・辛 | 庚 |
| 丁・壬 | 壬 |
| 戊・癸 | 甲 |

→ 寅→卯→辰…と1月ごとに干支を順行。

例：2023年（癸卯年）は「戊・癸」グループ → 寅月の月干=甲、卯月=乙、辰月=丙…。

---

### **日柱（日干・日支）**

* 60日周期で繰り返されるため、次のように計算：

  * 高氏日柱公式（簡易版）

`s = 西暦年の下2桁 - 1`  
`u = s % 4`  
`r = s * 4 * 6 + 5 * (s * 4 * 3 + u) + 月基数[m] + 日 + 世紀定数[x]`  
`干支番号 = r % 60`

*   
  * `月基数[m]` は月ごとに定義（例：1月=6, 2月=2, 3月=2, …）。

  * `世紀定数[x]` は西暦1900年代=0、2000年代=6 等。

* 干支番号から十干・十二支を照合テーブルで求める。

---

### **時柱（時干・時支）**

* 時支：2時間ごとに順行。

`子=23–1, 丑=1–3, 寅=3–5, 卯=5–7, 辰=7–9,`  
`巳=9–11, 午=11–13, 未=13–15, 申=15–17,`  
`酉=17–19, 戌=19–21, 亥=21–23`

* 時干：五鼠遁（ごそとん）の法則を使用。  
   | 日干 | 子時の時干 |  
   |------|------------|  
   | 甲・己 | 甲 |  
   | 乙・庚 | 丙 |  
   | 丙・辛 | 戊 |  
   | 丁・壬 | 庚 |  
   | 戊・癸 | 壬 |

子→丑→寅…と順に干を進める。

---

## **2\. 五行配点ロジック**

### **五行対応表**

| 天干 | 五行 |
| ----- | ----- |
| 甲・乙 | 木 |
| 丙・丁 | 火 |
| 戊・己 | 土 |
| 庚・辛 | 金 |
| 壬・癸 | 水 |

### **地支の蔵干（隠れ干）**

| 地支 | 含む干と比率(%) | 対応五行 |
| ----- | ----- | ----- |
| 子 | 癸(100) | 水 |
| 丑 | 己(60), 癸(30), 辛(10) | 土・水・金 |
| 寅 | 甲(60), 丙(30), 戊(10) | 木・火・土 |
| 卯 | 乙(100) | 木 |
| 辰 | 戊(60), 乙(30), 癸(10) | 土・木・水 |
| 巳 | 丙(60), 戊(30), 庚(10) | 火・土・金 |
| 午 | 丁(70), 己(30) | 火・土 |
| 未 | 己(60), 丁(30), 乙(10) | 土・火・木 |
| 申 | 庚(60), 壬(30), 戊(10) | 金・水・土 |
| 酉 | 辛(100) | 金 |
| 戌 | 戊(60), 辛(30), 丁(10) | 土・金・火 |
| 亥 | 壬(70), 甲(30) | 水・木 |

### **集計アルゴリズム**

`five_elements = {"木":0, "火":0, "土":0, "金":0, "水":0}`

`# 天干加算（36点固定）`  
`for gan in [year_gan, month_gan, day_gan, hour_gan]:`  
    `elem = GOKO_MAP[gan]`  
    `five_elements[elem] += 36`

`# 地支加算（蔵干比率100点）`  
`for shi in [year_shi, month_shi, day_shi, hour_shi]:`  
    `for (gan, ratio) in ZOKKAN_MAP[shi]:`  
        `elem = GOKO_MAP[gan]`  
        `five_elements[elem] += ratio`

→ 得点の総和から五行バランスを算出し、最小・最大値を抽出。

---

## **3\. 守護神（しゅごしん）選定ロジック**

### **手順**

1. 五行得点の最小値（不足）・最大値（過剰）を求める。

2. 不足五行があれば、それを守護神候補（補う要素）。

3. 過剰五行があれば、それを制御または消耗できる五行も候補に加える。

### **制御関係（相剋・相生表）**

| 作用 | 主語 | 効果対象 |
| ----- | ----- | ----- |
| 相生（育てる） | 木→火、火→土、土→金、金→水、水→木 |  |
| 相剋（制する） | 木→土、火→金、土→水、金→木、水→火 |  |

### **選定ルール**

* 不足五行を第一守護神。

* 過剰五行を抑制する五行を第二守護神。

* 複数候補がある場合は優先順位：不足補完 \> 過剰制御。

### **出力例**

`{`  
  `"five_elements_score": {"木":180,"火":70,"土":210,"金":140,"水":90},`  
  `"deficient": ["火","水"],`  
  `"excess": ["土"],`  
  `"guardian_gods": ["火","水"],`  
  `"taboo_elements": ["土"]`  
`}`

---

## **4\. 実装仕様（API内部）**

* 入力：生年月日・時刻

* 出力：

`{`  
  `"year_gan":"庚","year_shi":"子",`  
  `"month_gan":"甲","month_shi":"寅",`  
  `"day_gan":"丙","day_shi":"辰",`  
  `"hour_gan":"戊","hour_shi":"申",`  
  `"five_elements_score":{"木":..., "火":..., "土":..., "金":..., "水":...},`  
  `"guardian_gods":["火","水"],`  
  `"taboo_elements":["金"]`  
`}`

* 内部で：

  1. 干支計算（年・月・日・時）

  2. 五行配点集計

  3. 守護神判定

  4. 結果を `/api/v1/analyze` の `data.suanming` に埋め込み。

---

## **5\. テストケース例**

| テスト名 | 入力 | 期待結果 |
| ----- | ----- | ----- |
| Case1 | 2020-02-05 12:00 | 年干支=庚子, 守護神=火性 |
| Case2 | 1988-07-10 15:00 | 年干支=戊辰, 守護神=水性 |
| Case3 | 2001-12-30 22:00 | 年干支=辛巳, 守護神=木性 |

---

## **6\. パフォーマンス/再現性**

* 計算は純粋関数で実装（乱数・LLM依存なし）

* 時間計算複雑度 O(1)、一件あたり \< 5ms。

* 干支マッピング・蔵干・五行表は定数化（辞書キャッシュ）。

