# **5W1H（要件の一次整理）**

* Why（目的）

  * 算命学とマヤ暦を組み合わせ、女性の様々な悩み（仕事/恋愛/人間関係/体調/運気など）に対し、日付入力だけで再現性のある助言を返すツールを提供する。

  * アルゴリズム（決定論）で「基礎結果」を出し、LLM（大規模言語モデル）は説明/言い換え/提案の整形のみ（※ブレ防止）。

* What（提供価値/機能）

  * 入力フォーム：生年月日（必須）、出生時刻・出生地（任意）、相談カテゴリ。

  * 算命学エンジン：十干/十二支/日干支/十大主星/十二大従星 等の割当と相性/運勢期の計算。

  * マヤ暦エンジン：ツォルキン（260日）でKin、太陽の紋章、ウェイブスペル、銀河の音を算出。

  * 統合ロジック：両者の指標を正規化→重み付け→テーマ別スコア（仕事/恋愛/健康/自己成長）を算出。

  * LLM整形：結果の読みやすい要約、日常アクション提案、注意喚起のトーン調整。

  * 履歴/CSV出力/レポートPDF（β後半）。

* Who（対象/権限）

  * 一般ユーザー（匿名OK）: 日次/月次上限あり。

  * コンサルタント（管理者）: 購入ユーザーの履歴参照、テンプレ編集。

  * 開発者: 設定/辞書更新。

* When（スケジュール目安）

  * フェーズ1（2–3週）: API/計算ロジック/簡易UI/Sheets連携。

  * フェーズ2（+2週）: PDF出力/メール配信/管理画面/課金準備。

* Where（実行/配備）

  * Backend: Render（Flask, Python）。

  * Frontend: Vercel（React/Vite）。

  * DB代替: Google Sheets（Users/CalcLogs/Knowledge）。

* How（方式/制約）

  * 計算は決定論（Python）。LLMは説明整形のみ（max\_tokens/温度をUIで制御）。

  * セキュリティ：API鍵、CORS、環境変数、パスワードはハッシュ保存。

  * レート/コスト制御：ユーザー月間上限/1日上限、キュー処理（将来）。

# **不足/前提（保守的な補完案）**

* 出生時刻/出生地は任意（未入力時は正午/日本標準時で近似）。

* 相性/スコアの重みは初期値（算命学0.6, マヤ暦0.4）から開始、管理画面で調整。

* 相談カテゴリは {仕事, 恋愛, 人間関係, 健康, 金運, 学習} を初期セット。

* 免責：本サービスはエンタメ/自己理解支援目的（医療/法律/投資助言ではない）。

# **用語ミニ解説**

* LLM（大規模言語モデル）= 文章を生成/要約するAI。

* トークン \= モデルが扱う文字の単位（だいたい日本語の数文字）。

* CORS \= ブラウザから別ドメインAPIを呼ぶ際の安全制御。

* 正規化 \= 尺度の異なる数値を0–1に揃える処理。

≪ここまで≫

≪設計図MD：コピーここから≫  
 貼り先: 参考資料/システム設計

# **1\. 画面仕様（4ページ）**

共通UI：ヘッダー（ロゴ/設定）、フッター（免責/問い合わせ）。  
 設定スライダー：

* 「温度」= 0.0–2.0（小数1位）※LLMの創造性

* 「煽り度」= 1–10（整数）※表現の強さ

## **P1: ホーム/入力**

* フォーム: 氏名(任意), 生年月日(YYYY-MM-DD 必須), 出生時刻(HH:MM 任意), 出生地(任意), 相談カテゴリ(複数可), 悩み自由記述(任意)

* ボタン: 「結果を見る」→ /result

## **P2: 結果（算命学×マヤ暦）**

* 上部カード：総合スコア、今日/今週/今月のキーワード

* タブ：{総合, 仕事, 恋愛, 健康, 自己成長}

* セクション：

  * 算命学の要点（主星/従星/守護神など）

  * マヤ暦の要点（Kin/紋章/音/WS）

  * 統合インサイト（行動提案3件/注意点2件）

* アクション: 保存/コピー/CSV出力(β後)

## **P3: 履歴**

* 直近50件の検索履歴、フィルタ（カテゴリ/日付）。

* 詳細表示→再生成。

## **P4: 管理（管理者のみ）**

* 重み設定（算命学w1, マヤ暦w2）, 閾値、テンプレ文章。

* LLM設定：max\_tokens, 温度, 煽り度基準表。

* 知識ベース（用語辞書）編集。

# **2\. API設計（/api/v1）**

認証：`Authorization: Bearer <API_KEY>`（ユーザー毎に割当）。  
 共通レスポンス：`request_id`, `ts`, `data` or `error`.

## **POST /api/v1/analyze**

* 説明：算命学/マヤ暦を計算→統合→LLM整形

* 入力(JSON Schema 抜粋)

`{`  
  `"type":"object",`  
  `"required":["birthdate"],`  
  `"properties":{`  
    `"name":{"type":"string"},`  
    `"birthdate":{"type":"string","pattern":"^\\d{4}-\\d{2}-\\d{2}$"},`  
    `"birth_time":{"type":"string","pattern":"^\\d{2}:\\d{2}$"},`  
    `"birth_place":{"type":"string"},`  
    `"categories":{"type":"array","items":{"type":"string"}},`  
    `"free_text":{"type":"string"},`  
    `"llm_prefs":{`  
      `"type":"object",`  
      `"properties":{`  
        `"temperature":{"type":"number","minimum":0.0,"maximum":2.0},`  
        `"intensity":{"type":"integer","minimum":1,"maximum":10},`  
        `"max_tokens":{"type":"integer","minimum":256,"maximum":1200}`  
      `}`  
    `}`  
  `}`  
`}`

* 成功(200) data例（要点のみ）

`{`  
  `"request_id":"uuid",`  
  `"ts":"2025-10-23T12:34:56+09:00",`  
  `"data":{`  
    `"suanming":{`  
      `"day_stem":"甲",`  
      `"day_branch":"子",`  
      `"ten_stars":["・・・"],`  
      `"twelve_houses":["・・・"],`  
      `"periods":[{"from":"2025-01-01","to":"2034-12-31","label":"大運X"}]`  
    `},`  
    `"maya":{`  
      `"kin":128,`  
      `"solar_seal":"黄色い星",`  
      `"tone":11,`  
      `"wavespell":"・・・"`  
    `},`  
    `"scores":{"overall":0.72,"work":0.68,"love":0.75,"health":0.61,"growth":0.78},`  
    `"insights":[{"title":"・・・","advice":"・・・"}],`  
    `"llm":{"used_tokens":680,"temperature":0.5,"intensity":6}`  
  `}`  
`}`

## **POST /api/v1/validate**

* 説明：入力の構文/暦法上の妥当性チェックのみ（計算なし）

## **GET /api/v1/history?limit=50**

* 説明：自分の履歴取得（認証必須）

## **POST /api/v1/export**

* 説明：直近結果をCSV/PDF化（β後半）

### **エラー**

* 400: `{"error":{"code":"BAD_REQUEST","message":"birthdate required"}}`

* 401: `{"error":{"code":"UNAUTHORIZED"}}`

* 429: `{"error":{"code":"RATE_LIMIT","message":"monthly quota exceeded"}}`

* 500: `{"error":{"code":"INTERNAL","message":"unexpected error"}}`

# **3\. DB設計（Google Sheets）**

* `Users`

  * columns: id(UUID), email, api\_key(hash), role{user,admin}, monthly\_limit(int), used\_count(int), created\_at, updated\_at

  * 制約: email unique, api\_keyはハッシュ（bcrypt）

* `CalcLogs`

  * id, user\_id, birthdate, birth\_time, birth\_place, categories(csv), free\_text, suanming\_json, maya\_json, scores\_json, llm\_meta\_json, created\_at

  * 索引: user\_id, created\_at desc

* `Knowledge`

  * key, type{template,dict,weighing}, value(json), updated\_at

# **4\. エージェント設計**

* Agent1（分析）

  * 役割：算命学/マヤ暦の「説明テキスト」を各アルゴ出力から生成（事実は入力値のみに依存）。

  * LLM設定例：model=gpt-4o-mini、temperature=0.3、max\_tokens=700。

* Agent2（整形/統合）

  * 役割：女性向けに分かりやすく統合提案（行動3件/注意2件）、トーンは「優しく断定的」。

  * LLM設定例：temperature=ユーザー設定、max\_tokens=900、systemで免責を付与。

## **Agent2 厳格JSONスキーマ（契約）**

`{`  
  `"type":"object",`  
  `"required":["status","title","vsl_content","generation_metadata"],`  
  `"properties":{`  
    `"status":{"type":"string","enum":["SUCCESS","PARTIAL","ERROR"]},`  
    `"title":{"type":"string"},`  
    `"vsl_content":{`  
      `"type":"array",`  
      `"items":{`  
        `"type":"object",`  
        `"required":["part","duration_minutes","script_title","script_text"],`  
        `"properties":{`  
          `"part":{"type":"string"},`  
          `"duration_minutes":{"type":"integer"},`  
          `"script_title":{"type":"string"},`  
          `"script_text":{"type":"string"}`  
        `}`  
      `}`  
    `},`  
    `"generation_metadata":{`  
      `"type":"object",`  
      `"required":["composition","temperature_used","intensity_level"],`  
      `"properties":{`  
        `"composition":{"type":"string"},`  
        `"temperature_used":{"type":"number"},`  
        `"intensity_level":{"type":"integer"}`  
      `}`  
    `}`  
  `}`  
`}`

※ 本案件では `vsl_content` を「結果説明の3部構成」として利用。

# **5\. アルゴリズム（決定論コア）**

* 前処理：未指定の出生時刻は12:00、出生地はJSTのまま（将来、時差/地勢補正を追加）。

* 算命学：

  * 通書アルゴ（干支算出）→日干支。

  * 十大主星/十二大従星の割当（内部辞書）。

  * 守護神候補抽出（初期版は簡易ルール）。

* マヤ暦：

  * グレゴリオ暦→通日→Kin（1–260）。

  * Kin→太陽の紋章/銀河の音/ウェイブスペル（辞書）。

* 統合スコア：

  * 各指標→0–1正規化 → 重み `w_suan=0.6`, `w_maya=0.4` → テーマ別合成。

  * 閾値により提案テンプレを切替（Knowledge表）。

# **6\. 非機能**

* 目標応答：P95 \< 3s（キャッシュあり）。

* コスト：1件あたりLLM \< 1Kトークン、ユーザー月50件まで（初期）。

* ログ：PII最小化、request\_idで相関、エラーはStackdriver風JSON。

# **7\. セキュリティ**

* APIキーは環境変数で発行/保存はハッシュ、HTTPS前提。

* CORSはフロントのオリジン限定、レート制限（IP+ユーザー）。

* 監査：管理操作は必ずログ。

≪ここまで≫

≪Claudecode実装タスク指示書：コピーここから≫  
 貼り先: Claudecode 新規チャット冒頭

# **目的**

算命学×マヤ暦の決定論アルゴと、LLM整形を組み合わせた女性向けコンサル支援ツールのMVPを実装する。

# **完成定義（DoD）**

* `/api/v1/analyze` が仕様通り動作し、UI4ページから入力→結果→履歴が一連で利用可能。

* Google Sheets（Users/CalcLogs/Knowledge）に記録され、月間上限が適用される。

* LLM整形はAgent2 JSON契約に準拠し、温度/煽り度が反映される。

* README/.env.sample/サービスアカウント手順/単体テストが揃っている。

# **フォルダ構成**

`/app`  
  `/api`  
    `__init__.py`  
    `main.py`  
    `auth.py`  
    `suanming.py`  
    `maya.py`  
    `integrate.py`  
    `agents.py`  
    `sheets.py`  
    `schemas.py`  
    `rate_limit.py`  
  `/frontend (React/Vite)`  
    `/src`  
      `main.tsx`  
      `App.tsx`  
      `pages/{Home.tsx,Result.tsx,History.tsx,Admin.tsx}`  
      `components/{Sliders.tsx,Card.tsx}`  
    `index.html`  
  `/tests`  
    `test_analyze.py`  
    `test_validate.py`  
  `README.md`  
  `.env.sample`

# **主要ファイル雛形（要点）**

* `api/schemas.py`：pydantic/自前でJSON Schema検証。

* `api/suanming.py`：干支/主星/従星計算（辞書はKnowledgeから）。

* `api/maya.py`：Kin/紋章/音/WS計算。

* `api/integrate.py`：正規化・重み付け・テーマ別スコア。

* `api/agents.py`：Agent1/Agent2呼び出し（LLMプロバイダSDK）。

* `api/sheets.py`：Google Sheetsラッパ（CRUD/バッチ）。

* `api/rate_limit.py`：ユーザー毎のカウント更新/検査。

* `api/auth.py`：APIキー検証（ハッシュ照合）。

# **依存ライブラリ**

* Python: `flask`, `pydantic`, `requests`, `google-api-python-client`, `google-auth`, `bcrypt`, `ratelimit`, `python-dateutil`

* Frontend: `react`, `vite`, `axios`, `zustand`

* テスト: `pytest`, `responses`

# **環境変数（.env.sample）**

`FLASK_ENV=production`  
`PORT=8080`  
`API_BASE=/api/v1`  
`CORS_ORIGINS=https://your-frontend.vercel.app`  
`GOOGLE_SERVICE_ACCOUNT_JSON_BASE64=...`  
`SHEETS_SPREADSHEET_ID=...`  
`OPENAI_API_KEY=...`  
`DEFAULT_MONTHLY_LIMIT=50`  
`W_SUAN=0.6`  
`W_MAYA=0.4`

# **APIエンドポイント詳細とcurl**

## **Analyze**

`curl -X POST $BASE/api/v1/analyze \`  
 `-H "Authorization: Bearer $API_KEY" -H "Content-Type: application/json" \`  
 `-d '{`  
  `"name":"Aさん",`  
  `"birthdate":"1992-07-15",`  
  `"birth_time":"12:00",`  
  `"birth_place":"Tokyo",`  
  `"categories":["仕事","恋愛"],`  
  `"free_text":"転職と結婚のタイミングが不安",`  
  `"llm_prefs":{"temperature":0.5,"intensity":6,"max_tokens":800}`  
`}'`

### **想定エラー**

* 400 BAD\_REQUEST（必須欠落/形式不正）

* 429 RATE\_LIMIT（月間上限超過）

* 500 INTERNAL（再試行可）

## **Validate**

`curl -X POST $BASE/api/v1/validate \`  
 `-H "Authorization: Bearer $API_KEY" -H "Content-Type: application/json" \`  
 `-d '{"birthdate":"1992-07-15"}'`

## **History**

`curl "$BASE/api/v1/history?limit=20" -H "Authorization: Bearer $API_KEY"`

# **単体テスト観点**

* 入力検証（境界：うるう年/形式違反/未来日）。

* 算命学/マヤ暦の計算一致（既知ケースとの照合）。

* 統合スコアの重み適用、0–1範囲。

* レート制限（49→50→51件で429）。

* Agent2のJSONスキーマ妥当性。

* シート書き込み失敗時のリトライ/フォールバック。

# **ログ/例外方針**

* `request_id` を全レイヤで引き回し、構造化JSONで出力。

* 予期しない例外は500で握り、内部スタックはログのみ。

* PII（氏名/メール）はマスク。

# **まず最初に出すもの（初回PRで必須）**

1. `README.md`（起動/テスト/デプロイ手順）

2. `.env.sample`

3. フォルダ雛形と空ファイル

4. Googleサービスアカウント手順（下記）

5. フロントの4ページ骨格（入力→結果モック）

# **Googleサービスアカウント手順（要約）**

* GCPでサービスアカウント作成→JSON鍵を取得→Base64化して環境変数に設定。

* 対象スプレッドシートを「編集者」で共有。

* `SHEETS_SPREADSHEET_ID` を環境に設定。

# **コスト/レート制御**

* 1回あたり `max_tokens<=900`、温度と煽り度をUIから渡す。

* ユーザー当月上限=50件（`.env`で調整）。

* 429時は指数バックオフ。

≪ここまで≫

≪受け入れチェックリスト：コピーここから≫  
 貼り先: レビュー手順

## **UI**

* 4ページが遷移可能（Home→Result→History→Admin）。

* スライダー「温度」「煽り度」がAPIパラメータに反映。

* 入力最小（生年月日のみ）で結果が表示。

## **機能**

* /analyze が計算→統合→整形まで一発で返す。

* /history で直近結果が時系列で取得。

* Sheetsに Users/CalcLogs/Knowledge が作成・更新。

* 月間上限到達時に429が返る。

## **精度/再現性**

* 同一入力で基礎計算結果（干支/Kin 等）が常に同じ。

* 重み変更がスコアに反映（数値の再計算を確認）。

* Agent2 JSONがスキーマバリデーションを通過。

## **セキュリティ**

* APIはHTTPS/Authorization必須。

* APIキーはハッシュ保存、.envに生鍵なし。

* CORSは許可オリジン限定。

* PIIマスキング・ログに生データなし。

## **コスト**

* LLM呼び出しの`max_tokens`が上限内。

* 月間50件の超過でブロック。

≪ここまで≫

≪デプロイ手順MD：コピーここから≫  
 貼り先: 運用手順

# **デプロイ（Backend: Render / Frontend: Vercel）**

## **0\) 事前準備**

* GCPサービスアカウントを作成し、Sheetsに編集権限付与。

* `.env` をRender/Vercelの環境変数に設定（API鍵/Sheet ID/OPENAI\_API\_KEY等）。

## **1\) Backend（Render）**

1. 新規Web Service → リポジトリ選択。

2. Runtime: Python 3.11 / Start Command: `gunicorn api.main:app -w 2 -b 0.0.0.0:$PORT`

3. Environment:

   * `FLASK_ENV=production`

   * `API_BASE=/api/v1`

   * `GOOGLE_SERVICE_ACCOUNT_JSON_BASE64=...`

   * `SHEETS_SPREADSHEET_ID=...`

   * `OPENAI_API_KEY=...`

   * `DEFAULT_MONTHLY_LIMIT=50`

   * `W_SUAN=0.6`, `W_MAYA=0.4`

4. CORS\_ORIGINS にフロントのドメインを設定。

5. デプロイ→/health（実装時に追加）で疎通確認。

## **2\) Frontend（Vercel）**

1. New Project → `/app/frontend` を選択。

2. Framework: Vite（React）→ Build: `vite build` / Output: `dist`。

3. 環境変数：`VITE_API_BASE=https://<render-app>.onrender.com/api/v1`。

4. デプロイ→ホームからAPI疎通確認。

## **3\) ドメイン/HTTPS**

* Vercelで独自ドメイン接続。Renderは自動HTTPS。

## **4\) メール配信（任意/β後）**

* SendGridを有効化し、APIキーをVercel/Renderに登録。

* `/export`でPDF生成→メール送信（テンプレはKnowledge）。

## **5\) ロールバック**

* Render/Vercelともに前バージョンへ即時ロールバック可能。

* 重要設定はGitタグで管理（`release-v0.1.0` 等）。

## **6\) 監視**

* Renderのログ/メトリクスを確認。

* 429/500の発生率を週次でレビュー、Knowledge/重みを調整。

